<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdn.tailwindcss.com"></script>
  <title>Leela Bazar</title>
  <meta name="description" content="Leela Bazar – Play Smart & Track Your Game Stats Easily." />
  <meta name="keywords" content="Leela Bazar, games, tracking, stats, online game" />
  <meta name="author" content="Leela Bazar Team" />
  <meta property="og:title" content="Leela Bazar" />
  <meta property="og:description" content="Play Smart. Track Smarter. Leela Bazar PWA." />
  <meta property="og:image" content="Logo.jpg" />
  <meta property="og:type" content="website" />
  <meta property="og:url" content="/" />
  <link rel="icon" type="image/png" sizes="192x192" href="Logo.jpg" />
  <link rel="apple-touch-icon" href="Logo.jpg">
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#FED7AA" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <meta name="apple-mobile-web-app-title" content="Leela Bazar">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
  <script type="module"
    src="firebaseicsjiwhiudnjscniqueh8e28e28d82hd82h82h22h8dwdhsujvskaie3nejf9wu2ewidj9wi02e3u48u5tugr9uw9d3hrujfe.js"></script>
  <script>
    if ("serviceWorker" in navigator) {
      window.addEventListener("load", () => {
        navigator.serviceWorker
          .register("service-worker.js")
          .then(() => console.log("Service Worker Registered"));
      });
    }
  </script>

</head>
<script src="Blocked.js"></script>

<body class="bg-gray-100">
  <h1 id="loggedUserFName" class="hidden"></h1>

  <script>setTimeout(() => {

      const name = document.getElementById('loggedUserFName').innerText;
      const mail = document.getElementById('loggedUserEmail').innerText;
      if (name == "" || mail == "") {
        window.location.href = "index.html";
      }

    }, 4000);


  </script>
  <div id="page-loader"
    class="fixed top-0 left-0 w-full h-full inset-1 bg-black bg-opacity-50 flex items-center justify-center z-50  transition-opacity duration-500 hidden">
    <div class="w-16 h-16 border-8 border-white border-t-transparent rounded-full animate-spin"></div>
  </div>

  <!-- HEADER -->
  <div class="bg-orange-200 z-40 left-0 w-full shadow-md rounded-b-3xl">
    <div class="p-5">

      <div onclick="window.location.href='index.html'" class="flex justify-between items-center">
        <div id="openSidebar" class="flex items-center gap-3 cursor-pointer">
          <img src="Logo.jpg" alt="Leela Bazar" class="w-11 h-11 rounded-full shadow-md" />
          <p id="loggedUserEmail" class="font-extrabold text-black text-2xl">Leela Bazar</p>
        </div>

        <div class="flex items-center gap-5 text-gray-900 text-2xl">

          <!-- GOOGLE TRANSLATE SCRIPT -->
          <script src="https://translate.google.com/translate_a/element.js?cb=googleTranslateElementInit"></script>
          <i onclick="window.location.href='App.html'" class="fa-solid fa-mobile hover:text-blue-600 transition"></i>
        </div>
      </div>


    </div>
  </div>

  <!-- TABLE -->
  <div class="mx-2">
    <div class="bg-white py-2 rounded-lg shadow">
      <h2 class="text-xl font-bold mb-4 mx-3 flex justify-between">
        <p>Chart Sheet </p>
        <p class="mr-1">Update</p>
      </h2>
      <div id="recordsBody">
        <div class="p-3 bg-orange-100 shadow rounded-lg border mb-3 flex justify-between animate-pulse">
          <div class="space-y-2">
            <div class="h-6 w-16 bg-gray-300 rounded"></div>
            <div class="h-5 w-24 bg-pink-300 rounded"></div>
          </div>
          <div class="h-8 w-20 bg-blue-900 rounded opacity-50"></div>
        </div>
        <div class="p-3 bg-orange-100 shadow rounded-lg border mb-3 flex justify-between animate-pulse">
          <div class="space-y-2">
            <div class="h-6 w-16 bg-gray-300 rounded"></div>
            <div class="h-5 w-24 bg-pink-300 rounded"></div>
          </div>
          <div class="h-8 w-20 bg-blue-900 rounded opacity-50"></div>
        </div>
        <div class="p-3 bg-orange-100 shadow rounded-lg border mb-3 flex justify-between animate-pulse">
          <div class="space-y-2">
            <div class="h-6 w-16 bg-gray-300 rounded"></div>
            <div class="h-5 w-24 bg-pink-300 rounded"></div>
          </div>
          <div class="h-8 w-20 bg-blue-900 rounded opacity-50"></div>
        </div>
        <div class="p-3 bg-orange-100 shadow rounded-lg border mb-3 flex justify-between animate-pulse">
          <div class="space-y-2">
            <div class="h-6 w-16 bg-gray-300 rounded"></div>
            <div class="h-5 w-24 bg-pink-300 rounded"></div>
          </div>
          <div class="h-8 w-20 bg-blue-900 rounded opacity-50"></div>
        </div>
        <div class="p-3 bg-orange-100 shadow rounded-lg border mb-3 flex justify-between animate-pulse">
          <div class="space-y-2">
            <div class="h-6 w-16 bg-gray-300 rounded"></div>
            <div class="h-5 w-24 bg-pink-300 rounded"></div>
          </div>
          <div class="h-8 w-20 bg-blue-900 rounded opacity-50"></div>
        </div>

        <div class="p-3 bg-orange-100 shadow rounded-lg border mb-3 flex justify-between animate-pulse">
          <div class="space-y-2">
            <div class="h-6 w-16 bg-gray-300 rounded"></div>
            <div class="h-5 w-24 bg-pink-300 rounded"></div>
          </div>
          <div class="h-8 w-20 bg-blue-900 rounded opacity-50"></div>
        </div>
        <div class="p-3 bg-orange-100 shadow rounded-lg border mb-3 flex justify-between animate-pulse">
          <div class="space-y-2">
            <div class="h-6 w-16 bg-gray-300 rounded"></div>
            <div class="h-5 w-24 bg-pink-300 rounded"></div>
          </div>
          <div class="h-8 w-20 bg-blue-900 rounded opacity-50"></div>
        </div>
        <div class="p-3 bg-orange-100 shadow rounded-lg border mb-3 flex justify-between animate-pulse">
          <div class="space-y-2">
            <div class="h-6 w-16 bg-gray-300 rounded"></div>
            <div class="h-5 w-24 bg-pink-300 rounded"></div>
          </div>
          <div class="h-8 w-20 bg-blue-900 rounded opacity-50"></div>
        </div>
        <div class="p-3 bg-orange-100 shadow rounded-lg border mb-3 flex justify-between animate-pulse">
          <div class="space-y-2">
            <div class="h-6 w-16 bg-gray-300 rounded"></div>
            <div class="h-5 w-24 bg-pink-300 rounded"></div>
          </div>
          <div class="h-8 w-20 bg-blue-900 rounded opacity-50"></div>
        </div>
      </div>

    </div>
  </div>
  </div>

  <!-- UPDATE BOX -->
  <div id="updatebox" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-40">
    <div class="fixed bottom-0 left-0 w-full bg-white rounded-t-3xl px-3 py-8 shadow-lg ">

      <div class="flex justify-between text-center">
        <div class="text-left">
          <h2 class="text-2xl font-bold">Update Data</h2>
          <p class="text-gray-600 mt-1">Chart Sheet</p>
        </div>
        <!-- Angle down -->
        <div onclick="showUpdateBox()"
          class="w-12 h-12 bg-gray-200 rounded-full border border-black flex items-center justify-center cursor-pointer hover:bg-gray-300 transition">
          <i class="fa-solid fa-angle-down text-black text-lg"></i>
        </div>
      </div>

      <form id="crudForm" class="grid grid-cols-1 mt-4 md:grid-cols-2 gap-4">

        <div class="space-y-2">
          <select name="Id" title="Select Tittle" required
            class="border border-black p-4 w-full font-bold text-black focus:outline-none focus:ring-0 rounded">
            <option value="">Select Applicant</option>
            <option value="Golden">Golden</option>
            <option value="Final">Final</option>
            <option value="MORNING SYNDICATE">MORNING SYNDICATE</option>
            <option value="KALYAN MORNING">KALYAN MORNING</option>
            <option value="SYNDICATE NIGHT">SYNDICATE NIGHT</option>
            <option value="LEELA BAZAR">LEELA BAZAR</option>
            <option value="RAJDHANI NIGHT">RAJDHANI NIGHT</option>
            <option value="SHAKTIMAAN">SHAKTIMAAN</option>
          </select>

          <select type="color" name="Mcolor" data-empty required
            class="w-full mt-2 h-14 border px-3 border-black  font-bold rounded cursor-pointer"
            onchange="this.style.backgroundColor=this.value; this.style.color='#fff'">
            <option value="#ffdbb4" style="background:#ffdbb4;color:black;">Peach</option>
            <option value="#FFD700" style="background:#FFD700;color:black;">Gold</option>
            <option value="#16A34A" style="background:#16A34A;color:white;">Green</option>
            <option value="#2563EB" style="background:#2563EB;color:white;">Blue</option>
            <option value="#7C3AED" style="background:#7C3AED;color:white;">Purple</option>
            <option value="#DC2626" style="background:#DC2626;color:white;">Red</option>
            <option value="#0F172A" style="background:#2b3a5c;color:white;">Dark Navy</option>
            <option value="#F59E0B" style="background:#eb9b11;color:black;">Amber</option>
          </select>
          <br>
          <select name="Day" title="Select Days" required
            class="border border-black mt-2 p-4 w-full font-bold text-black focus:outline-none focus:ring-0 rounded">
            <option value="Monday">Monday</option>
            <option value="Tuesday">Tuesday</option>
            <option value="Wednesday">Wednesday</option>
            <option value="Thursday">Thursday</option>
            <option value="Friday">Friday</option>
            <option value="Saturday">Saturday</option>
          </select>

          <input type="text" name="Category" value="General" required
            class="border hidden p-2 font-bold rounded focus:outline-none focus:ring-0" />
        </div>

        <div class="flex gap-3">
          <input type="date" name="Date" id="dateInput" placeholder="Date" required
            class="border p-3 text-sm rounded border-black w-1/3  font-bold focus:outline-none focus:ring-0" />
          <input type="time" name="Time" placeholder="Time Start" required
            class="border p-3 rounded w-1/3 border-black  font-bold focus:outline-none focus:ring-0" />
          <input type="time" name="End" placeholder="Time End" required
            class="border p-3 rounded w-1/3 border-black  font-bold focus:outline-none focus:ring-0" />

        </div>

        <div class="flex gap-3">
          <div class="w-1/3 space-y-2">
            <select name="Acolor" data-empty class="w-full h-14 border border-black rounded font-bold px-3" onchange="this.style.backgroundColor=this.value;
            this.style.color=['#FDBA74','#FFD700','#F59E0B'].includes(this.value)?'#000':'#fff';">
              <option value="#000000" style="background:#000000;color:white;">Black</option>
              <option value="#FDBA74" style="background:#FDBA74;color:black;">Peach</option>
              <option value="#FFD700" style="background:#FFD700;color:black;">Gold</option>
              <option value="#16A34A" style="background:#16A34A;color:white;">Green</option>
              <option value="#2563EB" style="background:#2563EB;color:white;">Blue</option>
              <option value="#7C3AED" style="background:#7C3AED;color:white;">Purple</option>
              <option value="#DC2626" style="background:#DC2626;color:white;">Red</option>
              <option value="#0F172A" style="background:#0F172A;color:white;">Dark Navy</option>
              <option value="#F59E0B" style="background:#F59E0B;color:black;">Amber</option>
            </select>

            <input type="number" name="Jodi" placeholder="Jodi"
              class="w-full p-4 border border-black rounded font-bold">
          </div>

          <div class="w-1/3 space-y-2">
            <select name="Bcolor" data-empty class="w-full h-14 border border-black rounded font-bold px-3" onchange="this.style.backgroundColor=this.value;
            this.style.color=['#FDBA74','#FFD700','#F59E0B'].includes(this.value)?'#000':'#fff';">
              <option value="#000000" style="background:#000000;color:white;">Black</option>
              <option value="#FDBA74" style="background:#FDBA74;color:black;">Peach</option>
              <option value="#FFD700" style="background:#FFD700;color:black;">Gold</option>
              <option value="#16A34A" style="background:#16A34A;color:white;">Green</option>
              <option value="#2563EB" style="background:#2563EB;color:white;">Blue</option>
              <option value="#7C3AED" style="background:#7C3AED;color:white;">Purple</option>
              <option value="#DC2626" style="background:#DC2626;color:white;">Red</option>
              <option value="#0F172A" style="background:#0F172A;color:white;">Dark Navy</option>
              <option value="#F59E0B" style="background:#F59E0B;color:black;">Amber</option>
            </select>

            <input type="number" name="Marks" placeholder="Marks"
              class="w-full p-4 border border-black rounded font-bold">
          </div>

          <div class="w-1/3 space-y-2">
            <select name="Ccolor" data-empty class="w-full h-14 border border-black rounded font-bold px-3" onchange="this.style.backgroundColor=this.value;
            this.style.color=['#FDBA74','#FFD700','#F59E0B'].includes(this.value)?'#000':'#fff';">
              <option value="#000000" style="background:#000000;color:white;">Black</option>
              <option value="#FDBA74" style="background:#FDBA74;color:black;">Peach</option>
              <option value="#FFD700" style="background:#FFD700;color:black;">Gold</option>
              <option value="#16A34A" style="background:#16A34A;color:white;">Green</option>
              <option value="#2563EB" style="background:#2563EB;color:white;">Blue</option>
              <option value="#DC2626" style="background:#DC2626;color:white;">Red</option>
              <option value="#396cb9" style="background:#6192dd;color:white;">Navy</option>
              <option value="#F59E0B" style="background:#F59E0B;color:black;">Amber</option>
            </select>

            <input type="number" name="Pennel" placeholder="Pennel"
              class="w-full p-4 border border-black rounded font-bold">
          </div>
        </div>

        <div class="flex justify-between gap-2">
          <button type="button" id="updateBtn" onclick="showLoader();"
            class="bg-blue-900 w-full md:w-[48.4vw] text-white py-4 rounded-full text-lg font-bold mt-8 shadow-md hover:bg-blue-700 transition">
            UPDATE
          </button> <button type="button" id="createBtn" onclick="showLoader();"
            class="bg-blue-900 w-full md:w-[48.4vw] text-white py-4 rounded-full text-lg font-bold mt-8 shadow-md hover:bg-blue-700 transition">
            CREATE
          </button>
        </div>
      </form>
    </div>
  </div>
  <script>
    function showUpdateBox() {
      const box = document.getElementById('updatebox');
      box.classList.add('hidden');
    }


    function showLoader() {
      const loader = document.getElementById('page-loader');
      loader.classList.remove('hidden', 'opacity-0');
      loader.classList.add('flex');
    }

    function hideLoader() {
      const loader = document.getElementById('page-loader');
      loader.classList.add('hidden', 'opacity-0');

    }


    const scriptURL = "https://script.google.com/macros/s/AKfycbyW6iFWJpgLR-oogi_GysEp_RXph9d9vaQ2idlMgsQQVAg3ee_XeKuqyI_HDyaqnwlG/exec";

    function getCurrentDateTime() {
      const now = new Date();
      return {
        date: now.toISOString().split("T")[0],
        time: now.toTimeString().slice(0, 5)
      };
    }
    function setTodayDate() {
      const input = document.getElementById("dateInput");
      const today = new Date();
      const yyyy = today.getFullYear();
      const mm = String(today.getMonth() + 1).padStart(2, "0");
      const dd = String(today.getDate()).padStart(2, "0");
      input.value = `${mm}/${dd}/${yyyy}`;
    }

    // Run on page load
    window.addEventListener("load", setTodayDate);
    // LOAD RECORDS
    async function fetchRecords() {

      try {
        const res = await fetch(`${scriptURL}?action=read`);
        const data = await res.json();
        const body = document.getElementById("recordsBody");
        body.innerHTML = "";

        // Keep track of already rendered Ids
        const renderedIds = new Set();

        data.records.reverse().forEach(r => {
          if (!renderedIds.has(r.Id)) {
            renderedIds.add(r.Id);

            const row = document.createElement("div");
            row.innerHTML = `
<div class="p-3 bg-orange-100 shadow rounded-lg border mb-3 flex justify-between">
  <div>
    <h2 class="font-bold text-lg text-gray-700">${r.Id}</h2>
    <p class="text-pink-600 font-extrabold text-lg">${r.Jodi || ""}${r.Marks ? "-" + r.Marks : ""}${r.Pennel ? "-" + r.Pennel : ""}</p>
  </div>

  <button onclick="fillForm('${r.Id}')" 
          class="bg-blue-900 text-white px-4 h-8 rounded hover:bg-yellow-600">
    Update
  </button>
</div>`;
            body.appendChild(row);
          }
        });


      } catch (err) {
        console.error("Error fetching records:", err);
      }
    }

    // FILL FORM (open update box)
    async function fillForm(Id) {
      showLoader();
      try {
        const res = await fetch(`${scriptURL}?action=read`);
        const data = await res.json();
        const record = data.records.find(r => r.Id == Id);
        if (record) {
          const form = document.getElementById("crudForm");
          Object.keys(record).forEach(key => {
            if (form[key]) form[key].value = record[key];
          });
          document.getElementById("updatebox").classList.remove("hidden");
          hideLoader();
        }
      } catch (err) {
        console.error("Error filling form:", err);
      }
    }

    // SUBMIT UPDATE
    document.getElementById("updateBtn").addEventListener("click", async (e) => {
      e.preventDefault();

      const form = document.getElementById("crudForm");
      const fd = Object.fromEntries(new FormData(form));

      const id = fd.Id;
      const date = fd.Date || document.getElementById("dateInput")?.value;

      if (!id || !date) {
        alert("Id and Date are required for update");
        return;
      }
      showLoader();
      try {
        const params = new URLSearchParams({
          action: "update",
          ...fd,
          Id: id,
          Date: date
        });

        const res = await fetch(`${scriptURL}?${params.toString()}`);
        const result = await res.json();

        if (result.status === "success") {
          // optional UI cleanup
          document.getElementById("updatebox").classList.add("hidden");
          form.reset();
          window.location.reload();
        }
      } catch (err) {
        console.error("Update error:", err);
      } finally {
        setTimeout(() => {
          window.location.reload();
        }, 300);
        hideLoader();
      }
    });

    // ADD / CREATE RECORD
    document.getElementById("createBtn").addEventListener("click", async (e) => {
      e.preventDefault();
      const form = document.getElementById("crudForm");
      const fd = Object.fromEntries(new FormData(form));

      if (!fd.Id) {
        alert("Name is required");
        return;
      }
      showLoader();
      setTodayDate();
      try {
        const res = await fetch(`${scriptURL}?action=create&${new URLSearchParams(fd).toString()}`);
        const result = await res.json();
        if (result.status === "success") {
          form.reset();
          fetchRecords();
          hideLoader();
          setTimeout(() => {
            window.location.reload();
          }, 300); // small delay so UI updates properly
        }
      } catch (err) {
        console.error("Error creating record:", err);
      } finally {
        setTimeout(() => {
          window.location.reload();
        }, 300);
        hideLoader();
      }
    });

    // INITIAL LOAD
    fetchRecords();
  </script>

</body>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.11.1/firebase-app.js";
  import {
    getAuth,
    onAuthStateChanged,
    signOut
  } from "https://www.gstatic.com/firebasejs/10.11.1/firebase-auth.js";
  import {
    getFirestore,
    getDoc,
    doc
  } from "https://www.gstatic.com/firebasejs/10.11.1/firebase-firestore.js";

  // ✅ Your Firebase config (USE YOUR OWN VALUES HERE)
  const firebaseConfig = {
    apiKey: "AIzaSyAKN5GR18VTFrKNgVG7FenD4aSTX3Q2PbA",
    authDomain: "gift-zone-project.firebaseapp.com",
    projectId: "gift-zone-project",
    storageBucket: "gift-zone-project.appspot.com",
    messagingSenderId: "806465456032",
    appId: "1:806465456032:web:becf8988a6dfabe43646c5",
    measurementId: "G-1ZLMWBP61Y",
  };

  // ✅ Initialize Firebase services
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  // ✅ On Auth Change: fetch and show user data
  onAuthStateChanged(auth, (user) => {
    if (user) {
      const loggedInUserId = localStorage.getItem("loggedInUserId");
      if (!loggedInUserId) {
        console.log("User ID not found in local storage.");
        return;
      }

      const docRef = doc(db, "users", loggedInUserId);
      getDoc(docRef)
        .then((docSnap) => {
          if (docSnap.exists()) {
            const userData = docSnap.data();
            let filt = document.getElementById("loggedUserFName").innerText = userData.firstName || "N/A";
            document.getElementById("loggedUserEmail").innerText = userData.email || "N/A";
            const lNameElement = document.getElementById("loggedUserLName");
            if (userData.lastName) {
              lNameElement.innerText = userData.lastName;
            } else {
              lNameElement.innerText = "-";
            }
          } else {
            console.log("No user document found in Firestore.");
          }
        })
        .catch((error) => {
          console.error("Error fetching user data:", error);
        });
    } else {
      console.log("User not signed in.");
      window.location.href = "index.html"; // Redirect to login
    }
  });

  // ✅ Logout
  const logoutButton = document.getElementById("logout");
  logoutButton.addEventListener("click", () => {
    localStorage.removeItem("loggedInUserId");
    signOut(auth)
      .then(() => {
        window.location.href = "index.html";
      })
      .catch((error) => {
        console.error("Error signing out:", error);
      });
  });

</script>

</html>